<!--
  -  Microsoft Windows rules Custom
  -  Author: Dathan Nobrega.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->

<!-- 400000 Group of windows rules. -->
<var name="DEF_ACCOUNTS">Administrator|admin|test|guest</var>

<group name="windows,">
    <rule id="400001" level="10">
        <if_sid>18102</if_sid>
        <id>^1074$|^6006$|^6005$</id>
        <description>Desligamento ou reinicialização anormal do Windows</description>
        <group>windows,shutdown,</group>
    </rule>
    <rule id="400002" level="10">
        <if_sid>18102</if_sid>
        <id>^6008$</id>
        <description>Desligamento anormal detectado no Windows</description>
        <group>windows,shutdown,</group>
    </rule>
    <rule id="400003" level="9">
        <if_sid>400001</if_sid>
        <time>6 pm - 8 am</time>
        <description>Desligamento fora do horário comercial</description>
        <group>windows,after_hours,</group>
    </rule>
    
    <!-- Regras referentes a USB -->
    <rule id="401000" level="10">
        <if_sid>18100</if_sid>
        <field name="win.system.eventID">2100</field>
        <field name="win.system.providerName">Microsoft-Windows-DriverFrameworks-UserMode</field>
        <description>Dispositivo USB foi conectado</description>
        <group>windows,usb,attached,</group>
      </rule>
    <rule id="401001" level="12">
        <if_sid>18100</if_sid>
        <field name="win.system.eventID">1010</field>
        <field name="win.system.providerName">Microsoft-Windows-DriverFrameworks-UserMode</field>
        <description>Dispositivo USB foi removido inesperadamente</description>
        <group>windows,usb,removed,</group>
      </rule>

    <rule id="401002" level="7">
        <if_sid>18100</if_sid>
        <field name="win.system.eventID">2900</field>
        <field name="win.system.providerName">Microsoft-Windows-DriverFrameworks-UserMode</field>
        <description>Remoção segura de dispositivo USB iniciada (UMDF Host solicitado para desligar)</description>
        <group>windows,usb,removed,safe,</group>
      </rule>
      
      <rule id="401003" level="7">
        <if_sid>18100</if_sid>
        <field name="win.system.eventID">2901</field>
        <field name="win.system.providerName">Microsoft-Windows-DriverFrameworks-UserMode</field>
        <description>Remoção segura de dispositivo USB concluída (UMDF Host desligado)</description>
        <group>windows,usb,removed,safe,</group>
      </rule>
    
    <!--  Essas 3 regras sao refentes a mudancas no grupo admin, tive que desativar a orinal pois dava pouco detalhe -->
    <rule id="60144" level="10">
        <overwrite>yes</overwrite>
        <if_sid>60113</if_sid>
        <field name="win.system.eventID">^636$|^4732$</field>
        <description>[Custom] Membro adicionado ao grupo de administradores: $(win.eventdata.memberSid)</description>
        <group>windows,group_changes,critical,</group>
        <mitre>
            <id>T1484</id>
        </mitre>
    </rule>
    <rule id="60145" level="7">
        <overwrite>yes</overwrite>
        <if_sid>60113</if_sid>
        <field name="win.system.eventID">^637$|^4733$</field>
        <description>[Custom] Membro removido de grupo de administradores: $(win.eventdata.memberSid)</description>
        <group>windows,group_changes,critical,</group>
        <mitre>
            <id>T1484</id>
        </mitre>
    </rule>
    <rule id="60154" level="0">
        <overwrite>yes</overwrite>
        <description>[Custom] Regra 60154 desativada - Administrators Group Changed</description>
    </rule>
    <!--  Essas 3 regras ACIMA sao refentes a mudancas no grupo admin, tive que desativar a orinal pois dava pouco detalhe -->
    
    <rule id="400008" level="12">
    <if_sid>18102</if_sid>
        <!-- Devemos alterar o nome das contas de acordo com o padrão de segurança da empresa, para evitar o uso de contas padrão. -->
        <match>User\s*Name:\s*$DEF_ACCOUNTS</match>
        <description>Login com conta padrão detectado</description>
        <group>windows,authentication_success,default_accounts,</group>
    </rule>
    <rule id="400009" level="13">
        <if_sid>18102</if_sid>
        <match>Logon Type:\s*(2|10)</match>
        <regex type="pcre2">User Name:\s*(svc_|service_)\w+</regex>
        <description>Uso interativo de conta de serviço detectado</description>
        <group>windows,misuse,service_account,</group>
    </rule>
    
    <!--  Eventos referentes a Logins como Brute Force mesma Origem -->
    <rule id="400100" level="12" frequency="10" timeframe="600">
        <if_matched_sid>60122</if_matched_sid>
        <same_field>win.eventdata.ipAddress</same_field>
        <description>Possivel Ataque de Brute-Force vindo da mesma origem:$(win.eventdata.ipAddress)</description>
        <mitre>
            <id>T1110</id>
        </mitre>
        <group>authentication_failed,windows,bruteforce,</group>
    </rule>
    <!--  Eventos referentes a Logins como Brute Force mesmo Destino -->
    <rule id="400101" level="12" frequency="10" timeframe="600">
        <if_matched_sid>60122</if_matched_sid>
        <same_field>win.eventdata.workstationName</same_field>
        <description>Possivel Ataque de Brute-Force para o host:$(win.eventdata.workstationName)</description>
        <mitre>
            <id>T1110</id>
        </mitre>
        <group>authentication_failed,windows,bruteforce,</group>
    </rule>
    <rule id="400102" level="10" frequency="10" timeframe="600">
        <if_matched_sid>60122</if_matched_sid>
        <same_field>win.eventdata.targetUserName</same_field>
        <description>Vários Logins vindo do mesmo usuário:$(win.eventdata.targetUserName)</description>
        <mitre>
            <id>T1110</id>
        </mitre>
        <group>authentication_failed,windows,bruteforce,</group>
    </rule>
    
    <rule id="400103" level="14">
    <if_matched_sid>400100</if_matched_sid>
    <if_sid>60106</if_sid> <!-- 60106 = Logon Successful -->
    <description>Brute force successful - login succeeded from $(win.eventdata.ipAddress)</description>
    <group>authentication_success,windows,bruteforce,</group>
    <mitre>
        <id>T1110</id>
    </mitre>
    </rule>
    <rule id="400104" level="12" frequency="10" timeframe="600">
    <if_matched_sid>60115</if_matched_sid>
    <description>Várias contas do Windows foram bloqueadas (possível ataque)</description>
    <group>windows,account_lockout,bruteforce,</group>
    <mitre>
        <id>T1110</id> <!-- Brute Force -->
    </mitre>
    </rule>
    <rule id="400105" level="10">
        <if_sid>60106</if_sid>
        <description>Login realizado fora do horário comercial</description>
        <group>windows,login,out_of_hours,</group>
        <time>6 pm - 8 am</time> <!-- fora do horário comercial (das 18h até as 08h do outro dia) -->
        <mitre>
            <id>T1078</id>
        </mitre>
    </rule>
    <!-- Evento criado para registrar Alteracao de senha -->
    <rule id="400106" level="3">
        <if_sid>60103</if_sid> <!-- Windows Security warning event com AUDIT SUCCESS-->
        <field name="win.system.eventID">^4724$</field>
        <description>A senha do usuario $(win.eventdata.targetUserName) foi alterada</description>
        <mitre>
            <id>T1005</id>
        </mitre>
    </rule>
    <rule id="400107" level="10" frequency="5" timeframe="300">
        <if_matched_sid>400106</if_matched_sid>
        <field name="win.system.eventID">^4724$</field>
        <description>Varias Alteracoes de senha em um curto periodo</description>
        <mitre>
            <id>T1005</id>
        </mitre>
    </rule>


      <!-- Logs referentes a erros no sistema-->
    <rule id="400130" level="12">
        <if_sid>63110</if_sid>
        <field name="win.system.eventID">^1104$</field>
        <description>Logs de Seguranca está cheio</description>
    </rule>

    <!-- Logs referentes a Limpeza de logs -->
    <rule id="400200" level="12">
        <if_sid>63104</if_sid>
        <field name="win.system.eventID">^104$</field>
        <description>$(win.system.message)</description>
        <group>logs_cleared,pci_dss_10.6.1,gpg13_10.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <mitre>
          <id>T1070.004</id>
        </mitre>
    </rule>
    <rule id="400202" level="12">
        <if_sid>63103</if_sid>
        <description>Os logs de Seguranca foram limpos</description>
        <group>logs_cleared,pci_dss_10.6.1,gpg13_10.1,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.6,tsc_CC7.2,tsc_CC7.3,</group>
        <mitre>
          <id>T1070.004</id>
        </mitre>
    </rule>

</group>
